# Hello OpenMP (Fortran + CMake)

[![CI](https://github.com/High-Performance-Linear-Algebra/hello_openmp/actions/workflows/CI.yml/badge.svg)](https://github.com/High-Performance-Linear-Algebra/hello_openmp/actions/workflows/CI.yml)

A minimal Fortran program built with CMake that demonstrates OpenMP by printing a greeting from each thread.

## Repository layout

- `hello-openmp.f90` — Fortran source demonstrating basic OpenMP parallelism.
- `CMakeLists.txt` — CMake project file to configure, find OpenMP, build, and link the executable.
- `.github/workflows/CI.yml` — GitHub Actions workflow to build (and run) the program in CI.
- `build/` — Local build directory (generated by CMake; not committed in CI).

---

## Fortran program (OpenMP)

File: `hello-openmp.f90`

Key points:
- Uses the OpenMP module `omp_lib` and intrinsic `iso_fortran_env` for portable I/O (`output_unit`).
- Retrieves the maximum number of threads via `omp_get_max_threads()` (stored in `nthreads`).
- Enters a parallel region with `!$omp parallel private(tid)`.
- Each thread obtains its thread id via `omp_get_thread_num()` and prints a line:
  
  `Hello, world! from thread <id>`

Snippet of the control flow:
- Declare: `integer :: tid, nthreads`
- Init: `nthreads = omp_get_max_threads()`
- Parallel region: each thread computes `tid = omp_get_thread_num()` and writes one line.

Notes:
- The order of printed lines is not guaranteed (threads run concurrently).
- You can control the number of threads with the environment variable `OMP_NUM_THREADS`.

---

## CMake project

File: `CMakeLists.txt`

Highlights:
- `cmake_minimum_required(VERSION 3.23)` — requires CMake 3.23+.
- `project(hello-openmp LANGUAGES Fortran)` — Fortran-only project.
- `find_package(OpenMP REQUIRED COMPONENTS Fortran)` — locates OpenMP and the Fortran component.
- `add_executable(hello-openmp hello-openmp.f90)` — defines the executable.
- `target_link_libraries(hello-openmp PRIVATE OpenMP::OpenMP_Fortran)` — links the OpenMP Fortran target (adds proper compile/link flags such as `-fopenmp` when using GCC/GFortran).

This target-based approach is portable across compilers and platforms supported by CMake.

---

## Build and run locally

Requirements:
- A Fortran compiler (e.g., `gfortran`) with OpenMP support.
- CMake 3.23 or newer.

Typical build on Linux:

```bash
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build --config Release
OMP_NUM_THREADS=4 ./build/hello-openmp
```

Notes:
- You can switch generators (e.g., Ninja) by adding `-G Ninja` to the configure step if Ninja is installed.
- Set `OMP_NUM_THREADS` to control parallelism, or omit it to let OpenMP use its default.

---

## Continuous Integration (GitHub Actions)

File: `.github/workflows/CI.yml`

What it does:
- Triggers on pushes to `main` (and can be extended to PRs).
- Checks out the repository and installs a recent CMake and a Fortran compiler.
- Configures and builds the project with CMake.
- Runs the resulting executable with a small number of threads to validate it executes.

Key steps (conceptually):
1. `actions/checkout` — fetch the sources.
2. `lukka/get-cmake` — ensure a recent CMake version compatible with the project.
3. `fortran-lang/setup-fortran` — install/configure `gfortran` on the runner.
4. `cmake -S . -B build -DCMAKE_BUILD_TYPE=Release` — configure.
5. `cmake --build build --config Release` — build.
6. `OMP_NUM_THREADS=4 ./build/hello-openmp` — run the program.

Tip: If you customize the build, prefer target-based flags in CMake (e.g., `target_compile_options`) rather than hardcoding compiler options in the workflow.

---

## Troubleshooting

- "OpenMP not found" — ensure your compiler supports OpenMP and that CMake can locate it. On GCC/GFortran, CMake typically adds `-fopenmp` automatically when linking the `OpenMP::OpenMP_Fortran` target.
- "Command not found: cmake" — install CMake ≥ 3.23 locally, or let the CI step fetch an up-to-date version.
- Runtime shows fewer threads than expected — confirm `OMP_NUM_THREADS` and whether your system's OMP runtime or container limits CPU availability.

---